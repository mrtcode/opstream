!function(f){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=f();else if("function"==typeof define&&define.amd)define([],f);else{var g;g="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,g.OpStream=f()}}(function(){return function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a="function"==typeof require&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}for(var i="function"==typeof require&&require,o=0;o<r.length;o++)s(r[o]);return s}({1:[function(require,module){function isNumber(n){return"number"==typeof n&&n%1===0}var InStream=function(options){options=options||{},this.maxLen=options.maxLen||20,this.ops=[],this.seq=0,this.drained=!0,this._send=function(){}};InStream.prototype.isReadable=function(){return this.ops.length&&this.ops[0].seq==this.seq+1},InStream.prototype.pop=function(){if(!this.isReadable())return null;var op=this.ops.shift();return this.seq++,this._send({ack:this.seq}),this.isReadable()||(this.drained=!0),op.data},InStream.prototype.insert=function(op){if(!(this.ops.length>=this.maxLen)){if(op.seq<=this.seq)return void this._send({ack:this.seq});if(!(op.seq-this.seq-1>this.maxLen)){for(var pos=0,i=0;i<this.ops.length;i++){var opi=this.ops[i];if(opi.seq==op.seq)return;opi.seq<op.seq&&(pos=i+1)}this.ops.splice(pos,0,op),this.drained&&this.onReadable&&this.isReadable()&&(this.drained=!1,setTimeout(this.onReadable,0))}}};var OutStream=function(options){options=options||{},this.retryTimeout=options.retryTimeout||1e4,this.maxNotAck=options.maxNotAck||10,this.ops=[],this.seq=0,this.sentSeq=0,this.lastSend=0,this._send=function(){}};OutStream.prototype.triggerSend=function(){if(this.isWaitingAck()&&Date.now()-this.lastSend>this.retryTimeout&&(this.sentSeq=this.ops[0].seq-1),this.ops.length&&this.sentSeq<this.ops[0].seq+this.maxNotAck)for(var i=0;i<this.ops.length;i++){var opi=this.ops[i];if(opi.seq>this.sentSeq&&(this._send(opi),this.sentSeq=opi.seq,this.lastSend=Date.now()),i+1>=this.maxNotAck)break}},OutStream.prototype.isWaitingAck=function(){return this.ops.length&&this.sentSeq>=this.ops[0].seq},OutStream.prototype.retry=function(){this.ops.length&&(this.sentSeq=this.ops[0].seq-1,this.triggerSend())},OutStream.prototype.push=function(data){this.seq++;var op={seq:this.seq,data:data};this.ops.push(op),this.triggerSend()},OutStream.prototype.acknowledge=function(seq){for(var n=0,i=0;i<this.ops.length;i++){var opi=this.ops[i];opi.seq<=seq&&(n=i+1)}n&&(this.ops.splice(0,n),this.triggerSend())};var OpStream=function(options){var opStream=this;options=options||{},this.pingIntervalMs=options.pingIntervalMs||5e3,this.pingTimeoutMs=options.pingTimeoutMs||3e3,this.inStream=new InStream({maxLen:options.inMaxLen}),this.outStream=new OutStream({retryTimeout:options.outRetryTimeout,maxNotAck:options.outMaxNotAck}),this.inStream._send=this._send.bind(this),this.outStream._send=this._send.bind(this),this.inStream.onReadable=function(){opStream.onReadable&&opStream.onReadable()},this.onReadable=null,this.onOnline=null,this.onOffline=null,this.lastPing=0,this.connectionStatus="online",this.paused=!1,this.timerInterval=null,this.pingTimeout=null,this.initTimer()};OpStream.prototype.initTimer=function(){var opStream=this;this.timerInterval=setInterval(function(){opStream.outStream.triggerSend(),opStream.triggerPing()},300)},OpStream.prototype.destroy=function(){clearInterval(this.timerInterval),this.pingTimeout&&(clearTimeout(this.pingTimeout),this.pingTimeout=null),this.onReadable=null,this.onOnline=null,this.onOffline=null},OpStream.prototype.setPaused=function(pause){pause?this.paused=!0:this.paused&&(this.paused=!1,this.outStream.triggerSend())},OpStream.prototype.pingTimeouted=function(){"online"==this.connectionStatus&&(this.connectionStatus="offline",this.onOffline&&this.onOffline())},OpStream.prototype.triggerPing=function(){Date.now()-this.lastPing>this.pingIntervalMs&&(this._send({ping:Date.now()}),this.pingTimeout=setTimeout(this.pingTimeouted.bind(this),this.pingTimeoutMs),this.lastPing=Date.now())},OpStream.prototype.ponged=function(packet){Date.now()-packet.pong;this.pingTimeout&&(clearTimeout(this.pingTimeout),this.pingTimeout=null),"offline"==this.connectionStatus&&(this.connectionStatus="online",this.onOnline&&this.onOnline())},OpStream.prototype.push=function(data){this.outStream.push(data)},OpStream.prototype.pop=function(){return this.inStream.pop()},OpStream.prototype._send=function(op){!this.paused&&this.send&&this.send(op)},OpStream.prototype.recv=function(packet){packet.seq?isNumber(packet.seq)&&this.inStream.insert(packet):packet.ack?isNumber(packet.ack)&&this.outStream.acknowledge(packet.ack):packet.ping?isNumber(packet.ping)&&this._send({pong:packet.ping}):packet.pong&&isNumber(packet.pong)&&this.ponged(packet)},module.exports=OpStream},{}]},{},[1])(1)});